name: ARCVM Kernel - Build
on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to build from'
        required: true
        default: 'main'
      commit_sha:
        description: 'Specific commit SHA (optional)'
        required: false
      manual_config:
        description: 'Upload modified .config file?'
        type: boolean
        default: false
        required: false
      architecture:
        description: 'Target architecture'
        type: choice
        options:
          - arm64
        default: 'arm64'
        required: true

env:
  git_tag: chromeos-5.10-
  version_tag: v1.2.0-sukisu-enhanced
  # Centralized configuration for both workflows
  KERNEL_CONFIG_ARTIFACT: kernel-config-files
  KERNEL_SOURCE_ARTIFACT: kernel-source-files
  PREPARATION_STATE_ARTIFACT: preparation-state

jobs:
  build:
    name: Build ARCVM Kernel
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        include:
          - arch: ${{ github.event.inputs.architecture || 'arm64' }}
            defconfig: defconfig
            kernel_image_name: Image.lz4
            build_config: arch/arm64/configs/defconfig
    env:
      LTO: thin
      ROOT_DIR: /
      KERNEL_DIR: ${{ github.workspace }}/kernel
      ARCH: ${{ matrix.arch }}
      DEFCONFIG: ${{ matrix.defconfig }}
      KERNEL_IMAGE_NAME: ${{ matrix.kernel_image_name }}

    steps:
      - name: Install Build Tools
        run: |
          # Same build tool installation as in original workflow
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends bc \
              bison build-essential ca-certificates flex git gnupg \
              libelf-dev libssl-dev lsb-release software-properties-common wget \
              libncurses-dev binutils-aarch64-linux-gnu gcc-aarch64-linux-gnu nuget gzip \
              rsync python3 device-tree-compiler ccache
          # LLVM setup etc.

      # Add caching for ccache to speed up builds
      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: ${{ runner.os }}-${{ matrix.arch }}-${{ env.git_tag }}
          max-size: 2G

      - name: Checkout Repositories
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch }}
          path: main

      - name: Use specific commit if provided
        if: github.event.inputs.commit_sha != ''
        run: |
          cd ${{ github.workspace }}/main
          git checkout ${{ github.event.inputs.commit_sha }}
      
      # Re-checkout KernelSU and other necessary repos
      - name: Checkout KernelSU
        uses: actions/checkout@v5
        with:
          repository: tiann/KernelSU
          path: KernelSU
          fetch-depth: 0

      - name: Download Preparation Artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.KERNEL_SOURCE_ARTIFACT }}-${{ matrix.arch }}
          path: ${{ github.workspace }}/kernel
        continue-on-error: true

      - name: Download Configuration from Preparation
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.KERNEL_CONFIG_ARTIFACT }}-${{ matrix.arch }}
          path: ${{ github.workspace }}/kernel_config
        continue-on-error: true

      - name: Apply Config from Preparation if Available
        run: |
          if [ -f "${{ github.workspace }}/kernel_config/.config.backup" ]; then
            echo "Using configuration from preparation workflow"
            mkdir -p ${{ github.workspace }}/kernel
            cp -v "${{ github.workspace }}/kernel_config/.config.backup" "${{ github.workspace }}/kernel/.config"
            if [ -f "${{ github.workspace }}/kernel_config/autoconf.h" ]; then
              mkdir -p ${{ github.workspace }}/kernel/include/generated/
              cp -v "${{ github.workspace }}/kernel_config/autoconf.h" "${{ github.workspace }}/kernel/include/generated/"
            fi
          else
            echo "No configuration found from preparation workflow. Make sure you have run the ARCVM Kernel - Preparation workflow first."
            echo "::warning::No preparation artifacts found! Please ensure you've run the preparation workflow first."
          fi

      - name: Verify Preparation Artifacts
        run: |
          if [ ! -d "${{ github.workspace }}/kernel" ] || [ ! -f "${{ github.workspace }}/kernel/.config" ]; then
            echo "::error::Missing required kernel files or configuration from preparation step"
            echo "Please ensure you have run the ARCVM Kernel - Preparation workflow first and artifacts were generated correctly."
            echo "If you continue, the build may fail or produce incorrect results."
            # Not exiting with error to allow for manual upload option
          else
            echo " Preparation artifacts verified. Ready to proceed with build."
          fi

      - name: Setup Manual Config Upload
        if: github.event.inputs.manual_config
        uses: actions/upload-artifact@v4
        with:
          name: upload-config
          path: .

      - name: Wait for Config Upload
        if: github.event.inputs.manual_config
        run: |
          echo "Please upload your modified .config file"
          echo "Upload it to the 'upload-config' artifact that was just created"
          echo "Then proceed with the workflow"
          sleep 30  # Give time for upload notice to be seen

      - name: Build Kernel
        working-directory: kernel
        env:
          KERNEL_IMAGE_NAME: ${{ matrix.kernel_image_name }}
          ARCH: ${{ matrix.arch }}
        run: |
          # Check for the build config file before sourcing
          if [ -f "${{ matrix.build_config }}" ]; then
            set -a && . ${{ matrix.build_config }}; set +a
          else
            echo "Build config file ${{ matrix.build_config }} not found. Proceeding without it."
          fi
          
          export DEFCONFIG=${{ matrix.defconfig }}
          if [ ! -z ${{ vars.EXPECTED_SIZE }} ] && [ ! -z ${{ vars.EXPECTED_HASH }} ]; then
            export KSU_EXPECTED_SIZE=${{ vars.EXPECTED_SIZE }}
            export KSU_EXPECTED_HASH=${{ vars.EXPECTED_HASH }}
          fi
          
          # Skip mrproper to preserve the kernel configuration
          # make LLVM=1 LLVM_IAS=1 DEPMOD=depmod DTC=dtc O=${PWD} mrproper
          
          # IMPORTANT: DO NOT reapply the defconfig here - it would overwrite our KernelSU configs
          # Instead, verify our configs are still present
          echo "ðŸ” Verifying KernelSU configurations before build:"
          grep -E "CONFIG_KSU=|CONFIG_KSU_SUKISU=" .config
          
          # Enable LTO options
          echo "ðŸ”§ Configuring LTO settings..."
          if [ "${{ github.event.inputs.DISABLE_LTO }}" == "true" ]; then
            echo "ðŸ”§ Disabling LTO for better debugging..."
            scripts/config --file .config -d LTO_CLANG -e LTO_NONE -d LTO_CLANG_THIN -d LTO_CLANG_FULL -d THINLTO
          else
            echo "ðŸ”§ Enabling LTO for performance..."
            scripts/config --file .config -e LTO_CLANG -d LTO_NONE -e LTO_CLANG_THIN -d LTO_CLANG_FULL -e THINLTO
          fi
          
          # Build with verbose output to catch errors
          echo "ðŸ”§ Building kernel with KernelSU integration..."
          make LLVM=1 LLVM_IAS=1 DEPMOD=depmod DTC=dtc O=${PWD} -j$(nproc) ${KERNEL_IMAGE_NAME} V=1 modules prepare-objtool
          
          # Make sure the kernel image was built successfully
          if [ ! -f "arch/${ARCH}/boot/${KERNEL_IMAGE_NAME}" ]; then
            echo "âŒ Kernel build failed - image not found!"
            exit 1
          fi
          
          # List the built kernel image
          ls -l -h ${PWD}/arch/${ARCH}/boot
          
          # Set the file path for artifact upload
          echo "file_path=${PWD}/arch/${ARCH}/boot/${KERNEL_IMAGE_NAME}" >> $GITHUB_ENV

      - name: Verify KernelSU Integration
        working-directory: kernel
        env:
          KERNEL_IMAGE_NAME: ${{ matrix.kernel_image_name }}
          ARCH: ${{ matrix.arch }}
        run: |
          echo "ðŸ” Verifying KernelSU integration in kernel..."
          KERNEL_IMAGE="arch/${ARCH}/boot/${KERNEL_IMAGE_NAME}"
          
          # Check if kernel image exists
          if [ ! -f "$KERNEL_IMAGE" ]; then
            echo "DEBUG: Current directory: $(pwd)"
            echo "DEBUG: ARCH=$ARCH, KERNEL_IMAGE_NAME=$KERNEL_IMAGE_NAME"
            echo "DEBUG: Looking for image at $KERNEL_IMAGE"
            echo "DEBUG: Listing arch directory contents:"
            ls -la arch/ || echo "arch/ directory not found"
            if [ -d "arch/${ARCH}" ]; then
              echo "DEBUG: Listing arch/${ARCH}/boot contents:"
              ls -la arch/${ARCH}/boot/ || echo "boot directory not found"
            fi
            echo "âŒ ERROR: Kernel image not found at $KERNEL_IMAGE"
            exit 1
          fi
          
          echo "âœ… Found kernel image: $(ls -lh $KERNEL_IMAGE)"
          
          # Create verification report
          echo "Creating KernelSU verification report..."
          {
            echo "=== KernelSU Integration Verification Report ==="
            echo "Date: $(date)"
            echo "Kernel image: ${KERNEL_IMAGE}"
            echo "Size: $(stat -c%s ${KERNEL_IMAGE}) bytes"
            echo ""
          
            echo "=== Kernel .config KSU Settings ==="
            grep -E "CONFIG_KSU|CONFIG_SUKISU|CONFIG_SUSFS|CONFIG_KPROBES|CONFIG_KPM" .config || echo "No KSU configs found in .config"
            echo ""
          
            echo "=== Looking for KSU symbols ==="
            if command -v llvm-nm &> /dev/null; then
              llvm-nm ${KERNEL_IMAGE} 2>/dev/null | grep -i "ksu" || echo "No KSU symbols found with llvm-nm"
            else
              nm -D ${KERNEL_IMAGE} 2>/dev/null | grep -i "ksu" || echo "No KSU symbols found with nm"
            fi
            echo ""
          
            echo "=== Strings Analysis ==="
            strings ${KERNEL_IMAGE} | grep -i "kernelsu" || echo "No 'kernelsu' strings found"
            strings ${KERNEL_IMAGE} | grep -i "ksu_" || echo "No 'ksu_' function prefixes found"
            echo ""
          
            echo "=== Extracting built-in config if possible ==="
            strings ${KERNEL_IMAGE} | grep -A 1 IKCFG_ST | grep -v IKCFG_ST | strings > extracted_config.txt || true
            if [ -s "extracted_config.txt" ]; then
              grep -E "CONFIG_KSU|CONFIG_SUKISU|CONFIG_SUSFS" extracted_config.txt || echo "No KSU configs found in built-in config"
            else
              echo "Could not extract built-in config"
            fi
          } > ksu_verification_report.txt
          
          # Show key findings
          echo "ðŸ” KernelSU configs in .config:"
          grep -E "^CONFIG_KSU=|^CONFIG_KSU_SUKISU=" .config || echo "âš ï¸ KernelSU not enabled in .config!"
          
          echo "ðŸ” Checking for KSU strings in kernel image:"
          strings ${KERNEL_IMAGE} | grep -i "kernelsu" || echo "âš ï¸ No 'kernelsu' strings found in binary"
          
          # Copy report to output package
          mkdir -p $GITHUB_WORKSPACE/output/package/
          cp ksu_verification_report.txt $GITHUB_WORKSPACE/output/package/

      - name: Pack Source Tree
        id: pack_source
        run: |
          # Create output directories
          KSUVER=${{ env.version }}
          mkdir -p $GITHUB_WORKSPACE/output
          mkdir -p $GITHUB_WORKSPACE/output/package

          # Copy kernel source and create source archive
          cp -r $KERNEL_DIR $GITHUB_WORKSPACE/output/kernel_source
          tar -czf $GITHUB_WORKSPACE/output/ARCVM-SUKISU-SOURCE.tar.gz -C $GITHUB_WORKSPACE/output kernel_source

          # Create README file with kernel information
          echo "Kernel Version: ${KSUVER}" > $GITHUB_WORKSPACE/output/package/README.txt
          echo "Target System: ChromeOS ARCVM" >> $GITHUB_WORKSPACE/output/package/README.txt
          echo "Architecture: ${{ matrix.arch }}" >> $GITHUB_WORKSPACE/output/package/README.txt

          # Conditionally copy kernel image file if it exists
          if [ ! -z "${{ env.file_path }}" ] && [ -f "${{ env.file_path }}" ]; then
            echo "Copying kernel image from ${{ env.file_path }}"
            cp "${{ env.file_path }}" $GITHUB_WORKSPACE/output/package/
          else
            echo "Warning: Kernel image file not available yet. Will be added in the Build Kernel step."
            # Create a placeholder file so the zip step doesn't fail if there's no kernel image
            echo "Kernel image will be built in next step" > $GITHUB_WORKSPACE/output/package/kernel_image_placeholder.txt
          fi

          # Create the ZIP file with available contents
          cd $GITHUB_WORKSPACE/output/package
          zip -r $GITHUB_WORKSPACE/output/ARCVM-SUKISU-ULTRA.zip .
          echo "zip_path=$GITHUB_WORKSPACE/output/ARCVM-SUKISU-ULTRA.zip" >> $GITHUB_ENV
      - name: Upload kernel-ARCVM-${{ matrix.arch }}-${{ env.version }}
        uses: actions/upload-artifact@v4
        with:
          name: kernel-ARCVM-${{ matrix.arch }}-${{ env.version }}-${{ env.version_tag }}
          path: "${{ env.zip_path }}"
          if-no-files-found: error

      - name: Notify build completion
        run: |
          echo "::notice::Build completed successfully for arch ${{ matrix.arch }}"
          echo "::notice::Kernel image is available as artifact: kernel-ARCVM-${{ matrix.arch }}-${{ env.version }}-${{ env.version_tag }}"
          echo "::notice::This is the final step in the sequential process. Download your kernel image from the artifacts."