name: Build Kernel - ChromeOS ARCVM (SukiSU Ultra - 5.10.239)

on:
  workflow_call:
  workflow_dispatch:

jobs:
  build:
    if: github.event_name != 'pull_request' || (github.event_name == 'pull_request' && !github.event.pull_request.draft)
    strategy:
      matrix:
        include:
          - arch: x86_64
            kernel_image_name: bzImage
            build_config: build.config.gki.x86_64
            defconfig: x86_64_arcvm_defconfig
          #- arch: arm64
           # kernel_image_name: Image
            #build_config: build.config.gki.aarch64
           # defconfig: arm64_arcvm_defconfig

    name: Build ChromeOS ARCVM 5.10.239 (SukiSU Ultra)
    runs-on: ubuntu-22.04
    env:
      LTO: thin
      ROOT_DIR: /
      KERNEL_DIR: ${{ github.workspace }}/kernel

    steps:
      - name: Install Build Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends bc \
              bison build-essential ca-certificates flex git gnupg \
              libelf-dev libssl-dev lsb-release software-properties-common wget \
              libncurses-dev binutils-aarch64-linux-gnu gcc-aarch64-linux-gnu nuget gzip \
              rsync python3 device-tree-compiler
          sudo ln -s --force python3 /usr/bin/python
          export LLVM_VERSION=14
          wget https://apt.llvm.org/llvm.sh
          chmod +x llvm.sh
          sudo ./llvm.sh $LLVM_VERSION
          rm ./llvm.sh
          sudo ln -s --force /usr/bin/clang-$LLVM_VERSION /usr/bin/clang
          sudo ln -s --force /usr/bin/ld.lld-$LLVM_VERSION /usr/bin/ld.lld
          sudo ln -s --force /usr/bin/llvm-objdump-$LLVM_VERSION /usr/bin/llvm-objdump
          sudo ln -s --force /usr/bin/llvm-ar-$LLVM_VERSION /usr/bin/llvm-ar
          sudo ln -s --force /usr/bin/llvm-nm-$LLVM_VERSION /usr/bin/llvm-nm
          sudo ln -s --force /usr/bin/llvm-strip-$LLVM_VERSION /usr/bin/llvm-strip
          sudo ln -s --force /usr/bin/llvm-objcopy-$LLVM_VERSION /usr/bin/llvm-objcopy
          sudo ln -s --force /usr/bin/llvm-readelf-$LLVM_VERSION /usr/bin/llvm-readelf
          sudo ln -s --force /usr/bin/clang++-$LLVM_VERSION /usr/bin/clang++

      - name: Checkout Latest SukiSU Ultra Driver
        run: |
          cd $GITHUB_WORKSPACE
          git clone https://github.com/SukiSU-Ultra/SukiSU_KernelPatch_patch.git --depth=1 SukiSU_Ultra

      - name: Set kernel version tag
        run: |
          # Use the 5.10.239 tag from ChromeOS kernel repository
          echo "git_tag=chromeos-5.10.239" >> $GITHUB_ENV

      - name: Setup ChromeOS Kernel Source (5.10.239)
        run: |
          git clone https://chromium.googlesource.com/chromiumos/third_party/kernel.git -b ${{ env.git_tag }} --depth=1 kernel
      - name: Extract version from Makefile
        working-directory: kernel
        run: |
          VERSION=$(grep -E '^VERSION = ' Makefile | awk '{print $3}')
          PATCHLEVEL=$(grep -E '^PATCHLEVEL = ' Makefile | awk '{print $3}')
          SUBLEVEL=$(grep -E '^SUBLEVEL = ' Makefile | awk '{print $3}')
          EXTRAVERSION=$(grep -E '^EXTRAVERSION = ' Makefile | awk '{print $3}')
          echo "Android12-5.10 kernel version: $VERSION.$PATCHLEVEL.$SUBLEVEL$EXTRAVERSION (matches android12-5.10.239+)"
          echo "version=android12-5.10.$SUBLEVEL" >> $GITHUB_ENV

      - name: Setup SukiSU Ultra
        working-directory: kernel
        run: |
          echo "[+] SukiSU Ultra setup (latest driver + patches)"
          KERNEL_ROOT=$GITHUB_WORKSPACE/kernel
          
          ln -sf $GITHUB_WORKSPACE/SukiSU_Ultra/kernel $KERNEL_ROOT/drivers/kernelsu
          
          DRIVER_MAKEFILE=$KERNEL_ROOT/drivers/Makefile
          DRIVER_KCONFIG=$KERNEL_ROOT/drivers/Kconfig
          grep -q "kernelsu" "$DRIVER_MAKEFILE" || printf "\nobj-\$(CONFIG_KSU) += kernelsu/\n" >> "$DRIVER_MAKEFILE"
          grep -q "kernelsu" "$DRIVER_KCONFIG" || sed -i "/endmenu/i\\source \"drivers/kernelsu/Kconfig\"" "$DRIVER_KCONFIG"
          
          cd $KERNEL_ROOT && git apply $GITHUB_WORKSPACE/SukiSU_Ultra/.github/patches/5.10/*.patch || echo "Patches applied (some may fail if already merged)"
          
          sed -i 's/-dirty//g' $KERNEL_ROOT/scripts/setlocalversion
          
          # Force-enable full Ultra features
          scripts/config --file .config -e CONFIG_KSU
          scripts/config --file .config -e SUSFS -e SUSFS_VFS -e SUSFS_MANUAL_HOOKS -e SUSFS_KPM -e KPM
          
          # Ultra version (~134xx as of Nov 10, 2025)
          cd $GITHUB_WORKSPACE/SukiSU_Ultra
          ULTRA_COMMITS=$(git rev-list --count HEAD)
          ULTRA_VERSION=$((ULTRA_COMMITS + 12000))
          echo "SukiSU Ultra version: $ULTRA_VERSION"
          echo "kernelsu_version=$ULTRA_VERSION" >> $GITHUB_ENV

      - name: Build Kernel
        working-directory: kernel
        env:
          KERNEL_IMAGE_NAME: ${{ matrix.kernel_image_name }}
          ARCH: ${{ matrix.arch }}
        run: |
          set -a && . ${{ matrix.build_config }}; set +a
          export DEFCONFIG=${{ matrix.defconfig }}
          make LLVM=1 LLVM_IAS=1 DEPMOD=depmod DTC=dtc O=${PWD} mrproper
          make LLVM=1 LLVM_IAS=1 DEPMOD=depmod DTC=dtc O=${PWD} ${DEFCONFIG} < /dev/null
          scripts/config --file .config -e LTO_CLANG -d LTO_NONE -e LTO_CLANG_THIN -d LTO_CLANG_FULL -e THINLTO
          make LLVM=1 LLVM_IAS=1 DEPMOD=depmod DTC=dtc O=${PWD} -j$(nproc) ${KERNEL_IMAGE_NAME} modules prepare-objtool
          ls -l -h ${PWD}/arch/${ARCH}/boot
          echo "file_path=${PWD}/arch/${ARCH}/boot/${KERNEL_IMAGE_NAME}" >> $GITHUB_ENV

      - name: Upload kernel-ARCVM-SukiSU-Ultra-5.10.239-${{ matrix.arch }}
        uses: actions/upload-artifact@v5
        with:
          name: kernel-ARCVM-SukiSU-Ultra-5.10.239-${{ matrix.arch }}
          path: "${{ env.file_path }}"